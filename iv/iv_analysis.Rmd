---
title: "iv_analysis"
output: html_document
---

```{r}
require(plm)
require(tidyverse)
```

```{r}
df <- read.csv('./panel_fires.csv')
df['Developed'] = df['Developed'] == 'True'
```

```{r}
df <- df %>%
  mutate(years_since_fire = ifelse(years_since_fire < 0, NaN, years_since_fire)) %>%
  mutate(fire_damage = ifelse(is.nan(years_since_fire), 0, fire_damage))

df['costs'] = (df['estimated_cost'] + df['imputed_land_value']
               + max(df['assessed_improvement_value'] - df['fire_damage'], 0))

df <- df[!duplicated(df[, c("MapBlkLot_Master", "year")]), ]

df['val'] = df['revenue']/df['costs']



df2 <- df %>%
  arrange(MapBlkLot_Master, year) %>%
  group_by(MapBlkLot_Master) %>%
  mutate(Developed_Previously = cumsum(lag(Developed, default = FALSE)) > 0) %>%
  ungroup()

head(df2)

```

```{r}
non.res.df <- df %>%
  filter(!use_definition %in% c('Multi-Family Residential', 'Single Family Residential'))

nrow(non.res.df)
non.res.pd <- pdata.frame(non.res.df, index=c("MapBlkLot_Master", "year"))

```

```{r}
pd <- pdata.frame(df, index=c("MapBlkLot_Master", "year"))
pdim(pd)

```

### Linear Probability Model (pooled)

```{r}
formula <- Developed ~ log1p(val) | log1p(fire_damage)

# Estimate using 2SLS for panel data
iv_model.lpm.pool <- plm::plm(formula, data = pd, model="pooling", effect = 'twoway')
```


```{r}
# Summary of the model
summary(iv_model.lpm.pool)

```
```{r}
# Robust standard errors
summary(iv_model.lpm.pool, vcov = vcovHC(iv_model.lpm.pool, type = "HC1"))
```
```{r}
mean(predict(iv_model.lpm.pool) < 0)

mean(predict(iv_model.lpm.pool) > 1)

```

```{r}
fixef(iv_model.lpm.pool)
```

## LPM (random effect)

```{r}
formula <- Developed ~ log1p(val) | log1p(fire_damage)

# Estimate using 2SLS for panel data
iv_model.random <- plm::plm(formula, data = pd2)
```

```{r}
# Summary of the model
summary(iv_model.random)


```


# Linear Model

```{r}
formula <- Net_Units_Completed ~ log1p(val) | log1p(fire_damage)

# Estimate using 2SLS for panel data
iv_model.pool <- plm::plm(formula, data = pd,
                     model="pooling")
summary(iv_model.pool)

```


## Robustness Check

```{r}
iv_model.lpm.pool <- plm::plm(formula, data = non.res.pd,
                              model="pooling", effect = 'twoway')
summary(iv_model.lpm.pool)
```