---
title: "bluesky"
output: html_document
date: "2022-12-14"
---

## Setup

```{r warning=FALSE, message=FALSE}
#library(gt)  
#library(gtsummary)
library(tidyverse)
library(rsq)
library(lme4)
library(caret)
#library(corrr)
library(knitr) 
#library(hdi)
require(gridExtra)
library(MASS)
```

```{r}
df4 <- read_csv('./cleaned_2011_data.csv')

df4 <- dplyr::select(df4, -MapBlkLot_Master, -BlockLot, -parcel_number)

df4 <- df4 %>%
  mutate_if(function(x) { is.numeric(x) & n_distinct(x) == 2}, as.logical)

df4 <- df4[!is.na(df4$geometry),]

df4 <- dplyr::select(df4, -geometry)
```

```{r}

lmh <- c('_low', '_med', '_high')
df4['Upzone_Ratio_Bin'] = cut_number(df4$Upzone_Ratio, 
                                        3, 
                                        labels=lmh)
df4['land_value_bin'] = cut_number(df4$assessed_land_value, 3, 
                                   labels=lmh)
df4['improvement_value_bin'] = cut_number(df4$assessed_improvement_value, 
                                          3,
                                          labels=lmh)

df4['year_property_built_na'] = is.na(df4$year_property_built) | (df4$year_property_built == 0)

df4$assessor_neighborhood <- addNA(df4$assessor_neighborhood)
df4$exemption_code_definition <- addNA(df4$exemption_code_definition)
df4$status_code <- addNA(df4$status_code)
df4$lot_code <- addNA(df4$lot_code)
df4$zoning_code <- addNA(df4$zoning_code)
df4$construction_type <- addNA(df4$construction_type)


```

```{r}
ncol(df4)

1 - mean(df4$Developed)

1 - mean(df4$inInventory)

```

### Remove illogical Values

```{r}
df4 <- df4[(df4$number_of_bedrooms >= 0) | is.na(df4$number_of_bedrooms),]
df4 <- df4[df4$basement_area >= 0,]
df4 <- df4[df4$year_property_built <= 2023 | is.na(df4$year_property_built),]

# There are 19 properties supposedly built before SF's founding. I set to year 0 
df4[is.na(df4$year_property_built), 'year_property_built'] <- 0
df4[0 < df4$year_property_built & df4$year_property_built <= 1776,]$year_property_built <- 0

```

### Ensure categorical variables are treated appropriately.

```{r}
# Area code that affects taxes
df4$tax_rate_area_code <- as.factor(df4$tax_rate_area_code)

# Property records are split up into volumes for organizational purposes.
# This is likely highly correlated with neighborhoods or census tracts.
df4$volume_number <- as.factor(df4$volume_number)

df4$supervisor_district <- as.factor(df4$supervisor_district)
df4$supervisor_district <- addNA(df4$supervisor_district)
```

### Baseline model

```{r, results='asis'}
base.mod <- glm(Developed ~ inInventory, df4, family='binomial')
summary(base.mod)

base.mod.latex <- base.mod %>%
  tbl_regression(exponentiate = TRUE, intercept=TRUE) %>%
  as_gt() %>%
  gtsave('basic.mod.tex', path='./')
 
```

### Exploratory Data Analysis




```{r, results='asis'}
corr_with_outcome <- df4 %>%
  mutate_if(is.logical, as.numeric) %>%
  correlate() %>%
  focus(Developed) %>%
  arrange(desc(abs(Developed))) %>%
  head(20)

tex_df <- kable(corr_with_outcome,
             format='latex',
             digits=3,
             caption = "Pearson correlation coefficient with outcome variable, development.")

tex_df

corr_with_outcome
```


```{r, results='asis'}


corr_with_treat <- df4 %>%
  mutate_if(is.logical, as.numeric) %>%
  correlate() %>%
  focus(inInventory) %>%
  arrange(desc(abs(inInventory))) %>%
  head(20)

tex_df2 <- kable(corr_with_treat,
             format='latex',
             digits=3,
             caption = "Pearson correlation coefficient with treatment variable, inventory site selection")

tex_df2


```


This is 555 California Street, the fourth largest skyscraper in SF. So the large land value and property values do not seem to be bogus.



### EDA




```{r}
ggplot(df4) +
  geom_boxplot(aes(x=Developed, y=log1p(buildable_envelope_1000)))+
  theme_bw()
ggsave('./figures/env_dev.png', height=3, width=3)
```

```{r}
ggplot(df4) +
  geom_boxplot(aes(x=Developed, y=log1p(assessed_land_value)))+
  theme_bw()
ggsave('./figures/landval_dev.png', height=3, width=3)
```

# Two-way interaction between residential and historic

```{r}

se <- function(x){
  return(sqrt(var(x)/length(x)))
}


two_way_interaction_plot <- function(factor1, factor2, response, factor2_name, xlab, title) {
  means=by(response, list(factor1, factor2), mean)
  ses=by(response, list(factor1, factor2), se)
  interaction.plot(x.factor=factor1, trace.factor=factor2, response=response, ylim=c(0,.025), col=c('blue','red'), xlab=xlab, trace.label = factor2_name, ylab='Development Rate')
title(title, font=10)
  for (i in 1:length(ses)){
    index = i #
    mean <- means[i]
    se <- ses[i]
    if (i <= 2) {
      lines(c(i,i),c(mean-se,mean+se), col='blue', type='o', lty=5) 
    } else {
      lines(c(i%/%2,i%/%2),c(mean-se,mean+se), col='red', type='o', lty=5) 
    }
  }
}
```

```{r}

with(df4, {
  two_way_interaction_plot(Historic, Residential_Dummy, Developed,
                           'residential_use', 'historic', 
                           'Do historic status and residential use interact?')
})
```

```{r}

hr_dev <- df4 %>%
  group_by(Historic, Residential_Dummy) %>%
  summarize(dev_rate = mean(Developed), n = n()) %>%
  ungroup() %>%
  mutate(se = sqrt(as.numeric(dev_rate) * (1 - as.numeric(dev_rate)) / n))


ggplot(hr_dev, aes(x = Historic, y=dev_rate, color=as.logical(Residential_Dummy))) + 
  geom_line() +
  labs(color='ResidentialDummy', y='development rate') +
  geom_errorbar(aes(x = Historic, ymin=dev_rate - 1.96*se, ymax=dev_rate + 1.96*se, width=.2)) +
  scale_y_continuous(labels = scales::percent) 

ggsave('./figures/res_historic_dev.png', width=3, height=3)


```




### Model fitting

I used forward selection to select variables, but it's turned off for creating this R markdown file since it takes an hour to run.

I gotta think more about nans. Cast nans to own category in factors. And omit 13 rows with no census data or x_coord or y_coord. 

```{r, eval=F}
mod.init <- glm(Developed ~ inInventory, family='binomial', df4)
summary(mod.init)
```


```{r}
options(max.print = 2000)
```

### Taking log transforms of land value and improvement value helps.



```{r}
mod.ex.ante <- glm(Developed ~ inInventory + 
                   zp_DensRestMulti + zp_OfficeComm + zp_PDRInd + zp_RH3_RM1 + 
                   zp_RH2 + zp_FormBasedMulti + zp_Redev +
                   permit_new_construction + 
                   permit_additions_alterations_or_repairs + permit_sign +
                   permit_grade_or_quarry_or_fill_or_excavate + 
                   permit_demolitions + permit_otc_alterations +
                   buildable_envelope_1000 + 
                   year_property_built_na  + year_property_built + supervisor_district  +
                   (Upzone_Ratio_Bin + Residential_Dummy + Historic + 
                   land_value_bin + improvement_value_bin)^2,
                   family = "binomial", data = df4, na.action='na.omit')

rsq.kl(mod.ex.ante)
AIC(mod.ex.ante)
BIC(mod.ex.ante)

summary(mod.ex.ante)
```


```{r}
mod.step.bic <- stepAIC(mod.init, 
                        direction='forward', 
                        scope=list(lower=mod.init$formula, 
                                   upper=mod.ex.ante$formula), 
                        k=log(nrow(df4)),
                        trace=FALSE)

mod.step.aic <- stepAIC(mod.init, 
                        direction='forward', 
                        scope=list(lower=mod.init$formula, 
                                   upper=mod.ex.ante$formula), 
                        k=2,
                        trace=FALSE)
summary(mod.step.aic)
summary(mod.step.bic)
```

```{r}
mod.step.final <- glm(Developed ~ inInventory + zp_DensRestMulti + zp_OfficeComm + 
                        zp_PDRInd + zp_RH3_RM1 + zp_RH2 + zp_FormBasedMulti + permit_new_construction + 
                        permit_additions_alterations_or_repairs + permit_sign + permit_demolitions + 
                        year_property_built_na + year_property_built + supervisor_district + 
                        Upzone_Ratio_Bin + Residential_Dummy + Historic + land_value_bin + 
                        improvement_value_bin + Upzone_Ratio_Bin:Residential_Dummy + 
                        Upzone_Ratio_Bin:Historic + Residential_Dummy:Historic + 
                        Residential_Dummy:land_value_bin,
                      data=df4, 
                      na.action='na.omit',
                      family='binomial')

rsq.kl(mod.step.final)
AIC(mod.step.final)
BIC(mod.step.final)

```



```{r}
summary(mod.step.final)
```

### Appendix

Robustness check involving 2011-2016 approvals

```{r}
robustness <- df4

robustness[is.na(robustness['Permit Issued Date'])
           | (robustness['Permit Issued Date'] > '2014-12-31'), 'Developed'] <- 0
```

```{r}
mod.init.robust <- glm(Developed ~ inInventory, family='binomial', robustness)
summary(mod.init.robust)
```

```{r}
mod.ex.ante.robust <- glm(Developed ~ inInventory + 
                   zp_DensRestMulti + zp_OfficeComm + zp_PDRInd + zp_RH3_RM1 + 
                   zp_RH2 + zp_FormBasedMulti + zp_Redev +
                   permit_new_construction + 
                   permit_additions_alterations_or_repairs + permit_sign +
                   permit_grade_or_quarry_or_fill_or_excavate + 
                   permit_demolitions + permit_otc_alterations +
                   buildable_envelope_1000 + 
                   year_property_built_na  + year_property_built + supervisor_district  +
                   (Upzone_Ratio_Bin + Residential_Dummy + Historic + 
                   land_value_bin + improvement_value_bin)^2,
                   family = "binomial", data = robustness, na.action='na.omit')
summary(mod.ex.ante.robust)
```


```{r}
mod.step.final.robust <- glm(Developed ~ inInventory + zp_DensRestMulti + zp_OfficeComm + 
                        zp_PDRInd + zp_RH3_RM1 + zp_RH2 + zp_FormBasedMulti + permit_new_construction + 
                        permit_additions_alterations_or_repairs + permit_sign + permit_demolitions + 
                        year_property_built_na + year_property_built + supervisor_district + 
                        Upzone_Ratio_Bin + Residential_Dummy + Historic + land_value_bin + 
                        improvement_value_bin + Upzone_Ratio_Bin:Residential_Dummy + 
                        Upzone_Ratio_Bin:Historic + Residential_Dummy:Historic + 
                        Residential_Dummy:land_value_bin,
                      data=robustness, 
                      na.action='na.omit',
                      family='binomial')
summary(mod.step.final.robust)

```