---
title: "bluesky"
output: html_document
date: "2022-12-14"
---

## Setup

```{r warning=FALSE, message=FALSE}
library(gt)  
library(gtsummary)
library(tidyverse)
library(rsq)
library(lme4)
library(caret)
library(corrr)
library(knitr) 
library(hdi)
```

```{r}
df4 <- read_csv('./cleaned_rhna4_data.csv')

df4 <- select(df4, -MapBlkLot_Master)

df4 <- df4 %>%
  mutate_if(function(x) { is.numeric(x) & n_distinct(x) == 2}, as.logical)
```

```{r}
lmh <- c('low', 'medium', 'high')

df4['Upzone_Ratio_Binned'] = cut_number(df4$Upzone_Ratio, 
                                        3, 
                                        labels=lmh)

df4['assessed_land_value_binned'] = cut_number(df4$assessed_land_value, 3, 
                                               labels=lmh)
df4['assessed_improvement_value_binned'] = cut_number(df4$assessed_improvement_value, 
                                                      3,
                                                      labels=lmh)



df4$neighborhood <- addNA(df4$neighborhood)
df4$exemption_type_code <- addNA(df4$exemption_type_code)
df4$status_code <- addNA(df4$status_code)
df4$lot_code <- addNA(df4$lot_code)
df4$zoning_code <- addNA(df4$zoning_code)
df4$construction_type <- addNA(df4$construction_type)
# Without above, I only have this many observations
nrow(df4) - 153046
```

```{r}
ncol(df4)

1 - mean(df4$Developed)

1 - mean(df4$inInventory)

```

```{r}
df4
```

### Remove illogical Values

```{r}
df4 <- df4[df4$n_rooms >= 0,]
df4 <- df4[df4$basement_area >= 0,]
df4 <- df4[df4$year_property_built <= 2023,]

# There are 19 properties supposedly built before SF's founding. I set to year 0 
df4[0 < df4$year_property_built & df4$year_property_built <= 1776,]$year_property_built <- 0

df4['yearBuiltMissing'] <- df4$year_property_built == 0

```

### Ensure categorical variables are treated appropriately.

```{r}
# Area code that affects taxes
df4$tax_rate_area_code <- as.factor(df4$tax_rate_area_code)

# Property records are split up into volumes for organizational purposes.
# This is likely highly correlated with neighborhoods or census tracts.
df4$volume_number <- as.factor(df4$volume_number)

df4$district <- as.factor(df4$district)
df4$district <- addNA(df4$district)
```

### Baseline model

```{r, results='asis'}
base.mod <- glm(Developed ~ inInventory, df4, family='binomial')
summary(base.mod)

base.mod.latex <- base.mod %>%
  tbl_regression(exponentiate = TRUE, intercept=TRUE) %>%
  as_gt() %>%
  gtsave('basic.mod.tex', path='./')
 
```

### Exploratory Data Analysis




```{r, results='asis'}
corr_with_outcome <- df4 %>%
  mutate_if(is.logical, as.numeric) %>%
  correlate() %>%
  focus(Developed) %>%
  arrange(desc(abs(Developed))) %>%
  head(20)

tex_df <- kable(corr_with_outcome,
             format='latex',
             digits=3,
             caption = "Pearson correlation coefficient with outcome variable, development.")

tex_df

corr_with_outcome
```


```{r, results='asis'}



corr_with_treat <- df4 %>%
  mutate_if(is.logical, as.numeric) %>%
  correlate() %>%
  focus(inInventory) %>%
  arrange(desc(abs(inInventory))) %>%
  head(20)

tex_df2 <- kable(corr_with_treat,
             format='latex',
             digits=3,
             caption = "Pearson correlation coefficient with treatment variable, inventory site selection")

tex_df2


```


This is 555 California Street, the fourth largest skyscraper in SF. So the large land value and property values do not seem to be bogus.


```{r}
df4[df4$assessed_land_value == max(df4$assessed_land_value),]
```

```{r message=FALSE}
ggplot(df4) + 
  geom_histogram(aes(log(1 + n_rooms)))
```

```{r message=FALSE}
ggplot(df4) + 
  geom_histogram(aes(homeowner_excemption_value))
```


```{r message=FALSE}
ggplot(df4) + 
  geom_histogram(aes(log(1 + basement_area)))
```


```{r message=FALSE}
ggplot(df4) +
  geom_histogram(aes(x=log(assessed_land_value + 1))) +
  facet_grid(Developed ~ ., scales = "free_y")
```

```{r message=FALSE}
ggplot(df4) +
  geom_histogram(aes(x=log(assessed_improvement_value + 1))) +
  facet_grid(Developed ~ ., scales = "free_y")
```


```{r}
table(df4$tax_rate_area_code)
```


### EDA

```{r}
ggplot(df4) +
  geom_point(aes(x=log1p(property_area_in_square_feet), y=log1p(lot_area), color=Developed), alpha=1, size=.1)

```

This is a bad plot that distorts proportions.
```{r}
ggplot(df4) +
  geom_boxplot(aes(x=Developed, y=log1p(Upzone_Ratio))) +
  theme_bw()

ggsave('./figures/upzone_ratio_dev_boxplot.png', width=3, height=3)
```

```{r}
ggplot(df4, aes(x = Developed, fill = as.factor(Residential_Dummy))) +
  geom_bar(position = "fill")+
  scale_y_continuous(labels = scales::percent) + 
  ylab('Proportion') +
  labs(fill='Residential') +
  theme_bw()

ggsave('./figures/residenital_vs_dev.png', height=3, width=3)
```

```{r}
ggplot(df4[df4$year_property_built > 0,]) +
  geom_boxplot(aes(x=Developed, y=year_property_built)) +
  theme_bw()

ggsave('./figures/yrblt_vs_dev.png', height=3, width=3)

```

```{r}
ggplot(df4, aes(x=Developed, fill=yearBuiltMissing)) +
  geom_bar(position = "fill") +
  theme_bw() +
  ylab('Proportion') +
  scale_y_continuous(labels = scales::percent) 

ggsave('./figures/yrblt_miss_vs_dev.png', height=3, width=3)

```


```{r}
ggplot(df4) +
  geom_boxplot(aes(x=Developed, y=log1p(buildable_envelope_1000)))+
  theme_bw()
ggsave('./figures/env_dev.png', height=3, width=3)
```

```{r}
ggplot(df4) +
  geom_boxplot(aes(x=Developed, y=log1p(assessed_land_value)))+
  theme_bw()
ggsave('./figures/landval_dev.png', height=3, width=3)
```

# Two-way interaction between residential and historic

```{r}

se <- function(x){
  return(sqrt(var(x)/length(x)))
}


two_way_interaction_plot <- function(factor1, factor2, response, factor2_name, xlab, title) {
  means=by(response, list(factor1, factor2), mean)
  ses=by(response, list(factor1, factor2), se)
  interaction.plot(x.factor=factor1, trace.factor=factor2, response=response, ylim=c(0,.025), col=c('blue','red'), xlab=xlab, trace.label = factor2_name, ylab='Development Rate')
title(title, font=10)
  for (i in 1:length(ses)){
    index = i #
    mean <- means[i]
    se <- ses[i]
    if (i <= 2) {
      lines(c(i,i),c(mean-se,mean+se), col='blue', type='o', lty=5) 
    } else {
      lines(c(i%/%2,i%/%2),c(mean-se,mean+se), col='red', type='o', lty=5) 
    }
  }
}
```

```{r}

with(df4, {
  two_way_interaction_plot(Historic, Residential_Dummy, Developed,
                           'residential_use', 'historic', 
                           'Do historic status and residential use interact?')
})
```

```{r}

hr_dev <- df4 %>%
  group_by(Historic, Residential_Dummy) %>%
  summarize(dev_rate = mean(Developed), n = n()) %>%
  ungroup() %>%
  mutate(se = sqrt(as.numeric(dev_rate) * (1 - as.numeric(dev_rate)) / n))


ggplot(hr_dev, aes(x = Historic, y=dev_rate, color=as.logical(Residential_Dummy))) + 
  geom_line() +
  labs(color='ResidentialDummy', y='development rate') +
  geom_errorbar(aes(x = Historic, ymin=dev_rate - 1.96*se, ymax=dev_rate + 1.96*se, width=.2)) +
  scale_y_continuous(labels = scales::percent) 

ggsave('./figures/res_historic_dev.png', width=3, height=3)


```


```{r}

steep_res_interact_df <- df4 %>%
  mutate(existing_residential_use = as.logical(Residential_Dummy)) %>%
  group_by(entirely_steep_lot, existing_residential_use) %>%
  summarise(development_rate = mean(Developed), n = n()) %>%
  mutate(se = sqrt(as.numeric(development_rate) * (1 - as.numeric(development_rate)) / n))


ggplot(steep_res_interact_df) + 
  aes(x = entirely_steep_lot, 
      color = existing_residential_use,
      group = existing_residential_use,
      y = development_rate)  +
  geom_line() +
  geom_errorbar(aes(ymin=development_rate - 1.96 * se, ymax=development_rate + 1.96 * se, width=.2)) +
  scale_y_continuous(labels = scales::percent ) 

ggsave('./figures/res_historic_dev.png', width=3, height=3)

```

### Model fitting

I used forward selection to select variables, but it's turned off for creating this R markdown file since it takes an hour to run.

I gotta think more about nans. Cast nans to own category in factors. And omit 13 rows with no census data or x_coord or y_coord. 

```{r}
hist(df4$property_area_in_square_feet)
```

```{r, eval=F}
mod.init <- glm(Developed ~ inInventory, family='binomial', df4)


to_log = c(#'assessed_land_value', 'assessed_improvement_value',
           'misc_exemption_value', 'assessed_personal_prop_value', 
           'assessed_fixtures_value', 'n_rooms', 'n_stories', 'n_units', 'n_bedrooms', 
           'homeowner_exemption_value', 'basement_area', 'lot_depth', 'lot_area',
           'lot_frontage', 'buildable_envelope_1000', 'existing_envelope_1000',
           'property_area_in_square_feet')

formula_str <- paste("log1p(", paste(to_log, collapse = ") + log1p("), ")", sep = "")

omit <- c('zoning_code', 'tax_rate_area_code',
          'volume_number',  'census_tract', 
          'district','property_class_code')

non_log <- setdiff(colnames(df4), c(to_log, c('Developed')))
non_log <- setdiff(non_log, omit)

formula_str <- paste0('Developed ~ ', formula_str, ' + ', paste("", paste(non_log, collapse = " + "), "", sep = ""))
interact <- c('Upzone_Ratio_Binned', 'Residential_Dummy', 
              'assessed_land_value_binned', 'assessed_improvement_value_binned')
interact_str <- paste("(", paste(interact, collapse = " + "), ")^2", sep = "")
formula_str <- paste0(formula_str, ' + ', interact_str)

mod.all <- glm(formula_str, family = 'binomial', df4, na.action='na.omit')

```

```{r}
# Remove nans
df4_no_nan <- na.omit(df4)
dmy <- dummyVars(' ~ .', data=df4_no_nan, fullRank=T)
df4_dummy <- data.frame(predict(dmy, newdata = df4_no_nan))
X <- select(df4_dummy, -DevelopedTRUE)
X <- sapply(X, as.numeric)
y <- df4_dummy$DevelopedTRUE
fit.multi <- multi.split(X, y, 
                         model.selector = lasso.firstq,
                         args.model.selector = list(q = 10),
                         parallel=TRUE)
fit.multi
head(fit.multi$pval.corr, 10) ## the first 10 p-values
ci. <- confint(fit.multi)
head(ci.) # the first 6
stopifnot(all.equal(ci.,
with(fit.multi, cbind(lci, uci)), check.attributes=FALSE))
```
# current_sales_date_yymmdd is all fucked up
# I should pick either district or neighborhood
# fd
```{r}
options(max.print = 2000)
summary(mod.all)
```

```{r, eval=F}
summary(step.mod)
```

```{r, eval=F}
rsq.kl(step.mod)
```

### Taking log transforms of land value and improvement value helps.

```{r}
mod.log <- glm(Developed ~ Upzone_Ratio + 
                 zp_DensRestMulti + zp_OfficeComm + zp_PDRInd + zp_RH3_RM1 + 
                 zp_RH2 + zp_FormBasedMulti + zp_Redev +
                 pipeline2 + pipeline3 + pipeline4 + pipeline5 + pipeline6 + pipeline8 +
                 log1p(assessed_land_value) + log1p(assessed_improvement_value) + log1p(n_rooms) + log1p(n_beds) +
                 DEPTH  + Historic + inInventory + Residential_Dummy + 
                 buildable_envelope_1000 + tax_rate_area_code + log1p(homeowner_excemption_value) + log1p(basement_area) + year_property_built, 
    family = "binomial", data = df4)

rsq.kl(mod.log)

summary(mod.log)

rsq.kl(base.mod)
AIC(base.mod)
BIC(base.mod)
rsq.kl(mod.log)
AIC(mod.log)
BIC(mod.log)

```

```{r}
base.mod %>%
  modelsummary(output = "table.tex")
```

```{r}

mod.log.latex <- mod.log %>%
  tbl_regression(exponentiate = TRUE, intercept=TRUE) %>%
  as_gt() %>%
  gt::as_latex()
```

```{r}
summary(mod.log)
```

```{r}
caret::confusionMatrix(data=as.factor(ifelse(predict(mod.log, select(df4, -zoning_code), type="response") > 0.5, TRUE, FALSE)),  
                       reference=as.factor(df4$Developed))

```

```{r}
caret::confusionMatrix(data=as.factor(as.logical(df4$inInventory)),  
                       reference=as.factor(df4$Developed))

```


```{r message=FALSE}
hist(mod.log$fitted.values)
ggplot(df4, aes(x = mod.log$fitted.values)) +
  geom_histogram() +
  scale_y_log10()

```




