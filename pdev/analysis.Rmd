---
title: "bluesky"
output: html_document
date: "2022-12-14"
---

## Setup

```{r warning=FALSE, message=FALSE}
library(gt)  
library(gtsummary)
library(tidyverse)
library(rsq)
library(lme4)
library(caret)
library(corrr)
library(knitr) 

```

```{r}
df4 <- read.csv('./cleaned_rhna4_data.csv')

df4 <- select(df4, -MapBlkLot_Master)
```

```{r}
ncol(df4)

1 - mean(df4$Developed)

1 - mean(df4$inInventory)

```

```{r}
df4
```

### Remove illogical Values

```{r}
df4$Developed <- df4$Developed > 0
df4 <- df4[df4$ROOMS >= 0,]
df4 <- df4[df4$FBA >= 0,]
df4 <- df4[df4$YRBLT <= 2023,]

# There are 19 properties supposedly built before SF's founding. I set to year 0 
df4[0 < df4$YRBLT & df4$YRBLT <= 1776,]$YRBLT <- 0

df4['yearBuiltMissing'] <- df4$YRBLT == 0

```

### Ensure categorical variables are treated appropriately.

```{r}
# Area code that affects taxes
df4$RP1TRACDE <- as.factor(df4$RP1TRACDE)

# Property records are split up into volumes for organizational purposes.
# This is likely highly correlated with neighborhoods or census tracts.
df4$RP1VOLUME <- as.factor(df4$RP1VOLUME)

df4$inInventory <- ifelse(df4$inInventory == 'True', 1, 0)
df4$entirely_steep_lot <- ifelse(df4$entirely_steep_lot == 'True', 1, 0)
df4$partly_steep_lot <- ifelse(df4$partly_steep_lot == 'True', 1, 0)

```

### Baseline model

```{r, results='asis'}
base.mod <- glm(Developed ~ inInventory, df4, family='binomial')
summary(base.mod)

base.mod.latex <- base.mod %>%
  tbl_regression(exponentiate = TRUE, intercept=TRUE) %>%
  as_gt() %>%
  gt::as_latex()
 
```

### Exploratory Data Analysis


```{r}
lapply(df4, min)
```

```{r, results='asis'}
corr_with_outcome <- df4 %>%
  correlate() %>%
  focus(Developed) %>%
  arrange(desc(abs(Developed)))

tex_df <- kable(corr_with_outcome,
             format='latex',
             digits=3,
             caption = "Pearson correlation coefficient with outcome variable, development.")

tex_df

corr_with_outcome
```


```{r, results='asis'}



corr_with_treat <- df4 %>%
  correlate() %>%
  focus(inInventory) %>%
  arrange(desc(abs(inInventory)))

tex_df2 <- kable(corr_with_treat,
             format='latex',
             digits=3,
             caption = "Pearson correlation coefficient with treatment variable, inventory site selection")

tex_df2


```


This is 555 California Street, the fourth largest skyscraper in SF. So the large land value and property values do not seem to be bogus.


```{r}
df4[df4$RP1LNDVAL == max(df4$RP1LNDVAL),]
```

```{r message=FALSE}
ggplot(df4) + 
  geom_histogram(aes(log(1 + ROOMS)))
```

```{r message=FALSE}
ggplot(df4) + 
  geom_histogram(aes(RP1EXMVL1))
```


```{r message=FALSE}
ggplot(df4) + 
  geom_histogram(aes(log(1 + FBA)))
```


```{r message=FALSE}
ggplot(df4) +
  geom_histogram(aes(x=log(RP1LNDVAL + 1))) +
  facet_grid(Developed ~ ., scales = "free_y")
```

```{r message=FALSE}
ggplot(df4) +
  geom_histogram(aes(x=log(RP1IMPVAL + 1))) +
  facet_grid(Developed ~ ., scales = "free_y")
```


```{r}
table(df4$RP1STACDE)
```


### EDA



RP1LNDVAL 0.057
zp DensRestMulti 0.045
owner occ -0.042
inInventory

```{r}
ggplot(df4) +
  geom_point(aes(x=SQFT, y=LAREA), alpha=.1)

```

This is a bad plot that distorts proportions.
```{r}
ggplot(df4) +
  geom_boxplot(aes(x=Developed, y=Upzone_Ratio)) +
  scale_y_log10()

ggsave('./figures/upzone_ratio_dev_boxplot.png', width=4, height=4)
```
```{r}
ggplot(df4,aes(x = Residential_Dummy,fill = Developed)) + 
    geom_bar(position = "fill")

ggsave('./figures/residenital_vs_dev.png', height=4, width=4)
```

```{r}
ggplot(df4[df4$YRBLT > 0,]) +
  geom_boxplot(aes(x=Developed, y=YRBLT))
ggsave('./figures/yrblt_vs_dev.png', height=4, width=4)

```
```{r}
ggplot(df4) +
  geom_boxplot(aes(x=Developed, y=yearBuiltMissing))


ggplot(df4, aes(yearBuiltMissing, fill=Developed)) +
  geom_bar(position = "fill")

ggsave('./figures/yrblt_miss_vs_dev.png', height=4, width=4)

```


```{r}
ggplot(df4) +
  geom_boxplot(aes(x=Developed, y=log1p(Envelope_1000)))
ggsave('./figures/env_dev.png', height=4, width=4)
```

```{r}
ggplot(df4) +
  geom_boxplot(aes(x=Developed, y=log1p(RP1LNDVAL)))
ggsave('./figures/landval_dev.png', height=4, width=4)
```

### Model fitting


I used forward selection to select variables, but it's turned off for creating this R markdown file since it takes an hour to run.

```{r, eval=F}
mod.init <- glm(Developed ~ 1, family='binomial', select(df4, -ZONE))
mod.all <- glm(Developed ~ . -neighborhood, family='binomial', select(df4, -ZONE, -EXEMPTYPE, -RP1PPTVAL, -RP1FXTVAL, -RP1EXMVL2, -RP1CLACDE))
step.mod <- step(mod.init, direction='forward', scope=formula(mod.all))
```

```{r, eval=F}
summary(step.mod)

```

```{r, eval=F}
rsq.kl(step.mod)
```

### Taking log transforms of land value and improvement value helps.

```{r}
mod.log <- glm(Developed ~ Upzone_Ratio + 
                 zp_DensRestMulti + zp_OfficeComm + zp_PDRInd + zp_RH3_RM1 + 
                 zp_RH2 + zp_FormBasedMulti + zp_Redev +
                 pipeline2 + pipeline3 + pipeline4 + pipeline5 + pipeline6 + pipeline8 +
                 log1p(RP1LNDVAL) + log1p(RP1IMPVAL) + log1p(ROOMS) + log1p(BEDS) +
                 DEPTH  + Historic + inInventory + Residential_Dummy + 
                 Envelope_1000 + RP1STACDE + log1p(RP1EXMVL1) + log1p(FBA) + YRBLT, 
    family = "binomial", data = df4)

rsq.kl(mod.log)

summary(mod.log)
```

```{r}
base.mod %>%
  modelsummary(output = "table.tex")
```

```{r}

mod.log.latex <- mod.log %>%
  tbl_regression(exponentiate = TRUE, intercept=TRUE) %>%
  as_gt() %>%
  gt::as_latex()
```

```{r}
summary(mod.log)
```

```{r}
caret::confusionMatrix(data=as.factor(ifelse(predict(mod.log, select(df4, -ZONE), type="response") > 0.5, TRUE, FALSE)),  
                       reference=as.factor(df4$Developed))

```

```{r}
caret::confusionMatrix(data=as.factor(as.logical(df4$inInventory)),  
                       reference=as.factor(df4$Developed))

```


```{r message=FALSE}
hist(mod.log$fitted.values)
ggplot(df4, aes(x = mod.log$fitted.values)) +
  geom_histogram() +
  scale_y_log10()

```

# Mixed effects

Turned off temporarily since this is something to evaluate at a later stage
```{r, eval=F}
mod2 <- glmer(Developed ~ . + (1 | RP1CLACDE) - (ZONE + neighborhood + Residential_Dummy + district + RP1CLACDE + CONSTTYPE + EXEMPTYPE + general_use_code), 
              family='binomial', 
              df4)


mod.log.er <- glmer(Developed ~ general_use_code + (1 | district) + Upzone_Ratio + 
                 zp_DensRestMulti + zp_OfficeComm + zp_PDRInd + zp_RH3_RM1 + 
                 zp_RH2 + zp_FormBasedMulti + zp_Redev +
                 pipeline2 + pipeline3 + pipeline4 + pipeline5 + pipeline6 + pipeline8 +
                 log1p(RP1LNDVAL) + log1p(RP1IMPVAL) + log1p(ROOMS) + log1p(BEDS) +
                 DEPTH + Historic + inInventory + Residential_Dummy + 
                 Envelope_1000 + RP1STACDE + log1p(RP1EXMVL1) + log1p(FBA) + YRBLT, 
                 family = "binomial", data = select(df4, -ZONE))

summary(mod.log.er)
```



