---
title: "bluesky"
output: html_document
date: "2022-12-14"
---

## Setup

```{r}
library(hdi)
library(tidyverse)
library(rsq)
library(lme4)
```

```{r}
df <- read.csv('./cleaned_rhna4_data.csv')

colnames(df)

df <- select(df, -X, -MapBlkLot_Master, -mapblklot, -blklot, -active, -geometry, -PROPLOC, -RP1PRCLID, -RP1TRACDE)
```

This is 555 California Street, the fourth largest skyscraper in SF. So the large land value and property values do not seem to be bogus.
```{r}
df[df$RP1LNDVAL == 256020000,]
```

```{r}

ggplot(df) +
  geom_violin(aes(x=Developed, y=RP1LNDVAL), alpha=.1)
```

```{r}
table(df$RP1STACDE)
```

```{r}
df <- df[df$ROOMS >= 0,]
```

```{r}
df <- df[df$FBA >= 0,]
summary(df)
```

### EDA

```{r}

ggplot(df) +
  geom_point(aes(x=SQFT, y=area), alpha=.1)

df <- df[df$YRBLT <= 2023,]


```


### Model fitting

Fit high dimensional multi-level effect model.

```{r}
df$Developed <- df$Developed > 0
```

I should try using forward selection.
```{r}
mod.init <- glm(Developed ~ 1, family='binomial', select(df, -ZONE))
mod.all <- glm(Developed ~ . -neighborhood, family='binomial', select(df, -ZONE, -EXEMPTYPE, -RP1PPTVAL, -RP1FXTVAL, -RP1EXMVL2, -RP1CLACDE))
step.mod <- step(mod.init, direction='forward', scope=formula(mod.all))
```

```{r}
summary(step.mod)

```

```{r}
rsq.kl(step.mod)
```

```{r}
mod2 <- glmer(Developed ~ . + (1 | RP1CLACDE) - (ZONE + neighborhood + Residential_Dummy + district + RP1CLACDE + CONSTTYPE + EXEMPTYPE + general_use_code), 
              family='binomial', 
              df)
```



